//@version=6
indicator("Alt-Market Regime v3.0 (TOTAL3 * OTHERS.D / ETHBTC) + Divergences", overlay=false, max_labels_count=500)

// === Inputs: timeframes & logic ===
src_tf_in  = input.timeframe("12H", "Source timeframe (symbols)")
lenFast    = input.int(55,  "WMA Fast",  minval=1)
lenSlow    = input.int(200, "WMA Slow",  minval=2)
smoothK    = input.int(3,   "Smoothing (WMA on ratio)", minval=1)

// === Inputs: colors & visuals ===
ratioClr   = input.color(color.white,  "Color: Ratio line")
fastClr    = input.color(color.orange, "Color: WMA Fast")
slowClr    = input.color(color.yellow, "Color: WMA Slow")

useBg      = input.bool(true, "Show background shading")
bgOnClr    = input.color(color.new(color.teal, 0), "BG: Risk-ON")
bgOffClr   = input.color(color.new(color.black,0), "BG: Risk-OFF")
transpBg   = input.int(82, "BG transparency (0..100)", minval=0, maxval=100)

// Markers
showMarks  = input.bool(true, "Show markers")
markSize   = input.string("small", "Marker size", options=["tiny","small","normal","large"])
regUpClr   = input.color(color.green,  "Marker: Regime UP")
regDnClr   = input.color(color.red,    "Marker: Regime DOWN")
impUpClr   = input.color(color.teal,   "Marker: Momentum UP")
impDnClr   = input.color(color.purple, "Marker: Momentum DOWN")

// Status panel
showTable   = input.bool(true, "Show status table")
tblTitleSz  = input.string("large",  "Table title size", options=["tiny","small","normal","large","huge"])
tblInfoSz   = input.string("normal", "Table info size",  options=["tiny","small","normal","large"])

// === Divergences ===
showDiv       = input.bool(true,  "Show divergences")
divLeftRight  = input.int(5,      "Pivot left/right (bars)", minval=1, maxval=50)
bullDivColor  = input.color(color.new(color.teal,   0), "Bullish divergence color")
bearDivColor  = input.color(color.new(color.fuchsia,0), "Bearish divergence color")
divLineWidth  = input.int(2,      "Divergence line width", minval=1, maxval=5)
showDivLabels = input.bool(true,  "Show divergence labels")

// === Helper: normalize H timeframes to minutes for security() ===
f_norm_tf(tf) =>
    string out = tf
    if tf == "12H"
        out := "720"
    else if tf == "8H"
        out := "480"
    else if tf == "6H"
        out := "360"
    else if tf == "4H"
        out := "240"
    else if tf == "3H"
        out := "180"
    else if tf == "2H"
        out := "120"
    else if tf == "1H"
        out := "60"
    out
src_tf = f_norm_tf(src_tf_in)

// === Sources ===
total3  = request.security("CRYPTOCAP:TOTAL3",   src_tf, close, barmerge.gaps_off, barmerge.lookahead_off)
othersD = request.security("CRYPTOCAP:OTHERS.D", src_tf, close, barmerge.gaps_off, barmerge.lookahead_off)
ethbtc  = request.security("BINANCE:ETHBTC",     src_tf, close, barmerge.gaps_off, barmerge.lookahead_off)

// === Composite ratio ===   (TOTAL3 * OTHERS.D) / ETHBTC
ratio_raw = ethbtc != 0 ? (total3 * othersD) / ethbtc : na

// % отклонение от WMA(lenSlow) + сглаживание
base   = ta.wma(ratio_raw, lenSlow)
ratioN = base != 0 ? (ratio_raw / base - 1) * 100 : na
ratio  = ta.wma(ratioN, smoothK)

// Trend MAs
wmaFast = ta.wma(ratio, lenFast)
wmaSlow = ta.wma(ratio, lenSlow)

// Logic
riskOn      = ratio > wmaSlow
riskOff     = ratio < wmaSlow
impulseUp   = ta.crossover(ratio, wmaFast)
impulseDown = ta.crossunder(ratio, wmaFast)
regimeUp    = ta.crossover(ratio, wmaSlow)
regimeDown  = ta.crossunder(ratio, wmaSlow)

// === Plots ===
plot(ratio,    "Alt-Market Ratio %", color=ratioClr, linewidth=2)
plot(wmaFast,  "WMA Fast",           color=fastClr)
plot(wmaSlow,  "WMA Slow",           color=slowClr)

// === Markers (константные размеры) ===
bool sTiny   = markSize == "tiny"
bool sSmall  = markSize == "small"
bool sNormal = markSize == "normal"
bool sLarge  = markSize == "large"

// Regime UP
plotshape(showMarks and sTiny   and regimeUp,   title="Regime UP tiny",   style=shape.triangleup,   location=location.bottom, color=regUpClr, size=size.tiny)
plotshape(showMarks and sSmall  and regimeUp,   title="Regime UP small",  style=shape.triangleup,   location=location.bottom, color=regUpClr, size=size.small)
plotshape(showMarks and sNormal and regimeUp,   title="Regime UP normal", style=shape.triangleup,   location=location.bottom, color=regUpClr, size=size.normal)
plotshape(showMarks and sLarge  and regimeUp,   title="Regime UP large",  style=shape.triangleup,   location=location.bottom, color=regUpClr, size=size.large)

// Regime DOWN
plotshape(showMarks and sTiny   and regimeDown, title="Regime DN tiny",   style=shape.triangledown, location=location.top,    color=regDnClr, size=size.tiny)
plotshape(showMarks and sSmall  and regimeDown, title="Regime DN small",  style=shape.triangledown, location=location.top,    color=regDnClr, size=size.small)
plotshape(showMarks and sNormal and regimeDown, title="Regime DN normal", style=shape.triangledown, location=location.top,    color=regDnClr, size=size.normal)
plotshape(showMarks and sLarge  and regimeDown, title="Regime DN large",  style=shape.triangledown, location=location.top,    color=regDnClr, size=size.large)

// Momentum UP
plotshape(showMarks and sTiny   and impulseUp,  title="Momentum UP tiny",   style=shape.circle, location=location.bottom, color=impUpClr, size=size.tiny)
plotshape(showMarks and sSmall  and impulseUp,  title="Momentum UP small",  style=shape.circle, location=location.bottom, color=impUpClr, size=size.small)
plotshape(showMarks and sNormal and impulseUp,  title="Momentum UP normal", style=shape.circle, location=location.bottom, color=impUpClr, size=size.normal)
plotshape(showMarks and sLarge  and impulseUp,  title="Momentum UP large",  style=shape.circle, location=location.bottom, color=impUpClr, size=size.large)

// Momentum DOWN
plotshape(showMarks and sTiny   and impulseDown, title="Momentum DN tiny",   style=shape.circle, location=location.top, color=impDnClr, size=size.tiny)
plotshape(showMarks and sSmall  and impulseDown, title="Momentum DN small",  style=shape.circle, location=location.top, color=impDnClr, size=size.small)
plotshape(showMarks and sNormal and impulseDown, title="Momentum DN normal", style=shape.circle, location=location.top, color=impDnClr, size=size.normal)
plotshape(showMarks and sLarge  and impulseDown, title="Momentum DN large",  style=shape.circle, location=location.top, color=impDnClr, size=size.large)

// Background shading
bgcolor(useBg ? (riskOn ? color.new(bgOnClr, transpBg) : riskOff ? color.new(bgOffClr, transpBg) : na) : na)

// === Status table ===
var tbl = table.new(position.top_right, 1, 3, border_color=color.new(color.white, 70))
if barstate.islast and showTable
    col = riskOn ? bgOnClr : riskOff ? bgOffClr : color.new(color.orange, 0)
    titleStr = riskOn ? "RISK-ON" : riskOff ? "RISK-OFF" : "NEUTRAL"
    table.cell(tbl, 0, 0, "ALT MARKET ("+src_tf_in+")", text_color=color.white, text_size=tblInfoSz,  bgcolor=color.new(color.black, 0))
    table.cell(tbl, 0, 1, titleStr,                      text_color=color.white, text_size=tblTitleSz, bgcolor=col)
    info = "ratio " + str.tostring(ratio, "#.#") + "  |  WMA "+str.tostring(lenFast)+"/"+str.tostring(lenSlow)
    table.cell(tbl, 0, 2, info,                          text_color=color.white, text_size=tblInfoSz,  bgcolor=color.new(color.black, 0))

// === Alerts (const strings) ===
alertcondition(regimeUp,    "Regime UP (Risk-ON)",    "Alt-Market Regime: RISK-ON (ratio crossed ABOVE Slow WMA)")
alertcondition(regimeDown,  "Regime DOWN (Risk-OFF)", "Alt-Market Regime: RISK-OFF (ratio crossed BELOW Slow WMA)")
alertcondition(impulseUp,   "Momentum UP (Fast X)",   "Alt-Market: momentum UP (ratio crossed ABOVE Fast WMA)")
alertcondition(impulseDown, "Momentum DOWN (Fast X)", "Alt-Market: momentum DOWN (ratio crossed BELOW Fast WMA)")

// =====================================================================
//                         D I V E R G E N C E S
// =====================================================================

// Память для последних подтверждённых пивотов (цены и индикатора)
var float prev_ph_price = na
var float prev_ph_ratio = na
var int   prev_ph_price_idx = na
var int   prev_ph_ratio_idx = na

var float prev_pl_price = na
var float prev_pl_ratio = na
var int   prev_pl_price_idx = na
var int   prev_pl_ratio_idx = na

if showDiv
    L = divLeftRight

    // Пивоты: подтверждаются через L баров справа
    ph_price = ta.pivothigh(total3, L, L)
    pl_price = ta.pivotlow (total3, L, L)
    ph_ratio = ta.pivothigh(ratio,  L, L)
    pl_ratio = ta.pivotlow (ratio,  L, L)

    ph_price_idx = not na(ph_price) ? bar_index - L : na
    pl_price_idx = not na(pl_price) ? bar_index - L : na
    ph_ratio_idx = not na(ph_ratio) ? bar_index - L : na
    pl_ratio_idx = not na(pl_ratio) ? bar_index - L : na

    // ---- Медвежья дивергенция: цена HH и Ratio LH
    if not na(ph_price) and not na(ph_ratio)
        if not na(prev_ph_price) and not na(prev_ph_ratio)
            isPriceHH = ph_price > prev_ph_price
            isRatioLH = ph_ratio < prev_ph_ratio
            if isPriceHH and isRatioLH
                // Линия между двумя верхними пивотами Ratio — ОДНОСТРОЧНО!
                _ = line.new(prev_ph_ratio_idx, prev_ph_ratio, ph_ratio_idx, ph_ratio, xloc=xloc.bar_index, extend=extend.none, color=bearDivColor, style=line.style_solid, width=divLineWidth)
                if showDivLabels
                    _ = label.new(ph_ratio_idx, ph_ratio, "Bear div", style=label.style_label_down, color=bearDivColor, textcolor=color.white)
        // обновляем предыдущие high-пивоты
        prev_ph_price     := ph_price
        prev_ph_price_idx := ph_price_idx
        prev_ph_ratio     := ph_ratio
        prev_ph_ratio_idx := ph_ratio_idx

    // ---- Бычья дивергенция: цена LL и Ratio HL
    if not na(pl_price) and not na(pl_ratio)
        if not na(prev_pl_price) and not na(prev_pl_ratio)
            isPriceLL = pl_price < prev_pl_price
            isRatioHL = pl_ratio > prev_pl_ratio
            if isPriceLL and isRatioHL
                _ = line.new(prev_pl_ratio_idx, prev_pl_ratio, pl_ratio_idx, pl_ratio, xloc=xloc.bar_index, extend=extend.none, color=bullDivColor, style=line.style_solid, width=divLineWidth)
                if showDivLabels
                    _ = label.new(pl_ratio_idx, pl_ratio, "Bull div", style=label.style_label_up, color=bullDivColor, textcolor=color.white)
        // обновляем предыдущие low-пивоты
        prev_pl_price     := pl_price
        prev_pl_price_idx := pl_price_idx
        prev_pl_ratio     := pl_ratio
        prev_pl_ratio_idx := pl_ratio_idx

// =====================================================================
//                    DIVERGENCE ALERTS (append-only)
// =====================================================================

// Вкл/выкл алертов и режим "только на закрытии"
enableDivAlerts  = input.bool(true,  "Enable divergence alerts", inline="DIV_ALERTS")
alertsOnBarClose = input.bool(true,  "Alerts only on bar close", inline="DIV_ALERTS")

// --- Глобальные переменные для памяти и пульсов (чтобы их видеть вне if)
var float prev_ph_price_a = na
var float prev_ph_ratio_a = na
var float prev_pl_price_a = na
var float prev_pl_ratio_a = na
var bool  bearDivPulse_a  = false
var bool  bullDivPulse_a  = false

// Каждый бар сбрасываем пульсы
bearDivPulse_a := false
bullDivPulse_a := false

if enableDivAlerts
    // Используем те же настройки пивотов
    L_a = divLeftRight

    // Пивоты для контура алертов
    ph_price_a = ta.pivothigh(total3, L_a, L_a)
    pl_price_a = ta.pivotlow (total3, L_a, L_a)
    ph_ratio_a = ta.pivothigh(ratio,  L_a, L_a)
    pl_ratio_a = ta.pivotlow (ratio,  L_a, L_a)

    // ----- Медвежья дивергенция: цена HH, Ratio LH
    if not na(ph_price_a) and not na(ph_ratio_a)
        if not na(prev_ph_price_a) and not na(prev_ph_ratio_a)
            if ph_price_a > prev_ph_price_a and ph_ratio_a < prev_ph_ratio_a
                bearDivPulse_a := true
        prev_ph_price_a := ph_price_a
        prev_ph_ratio_a := ph_ratio_a

    // ----- Бычья дивергенция: цена LL, Ratio HL
    if not na(pl_price_a) and not na(pl_ratio_a)
        if not na(prev_pl_price_a) and not na(prev_pl_ratio_a)
            if pl_price_a < prev_pl_price_a and pl_ratio_a > prev_pl_ratio_a
                bullDivPulse_a := true
        prev_pl_price_a := pl_price_a
        prev_pl_ratio_a := pl_ratio_a

// --- Глобальные условия алертов (вне if)
divBarConfirmed_a = alertsOnBarClose ? barstate.isconfirmed : true
bullDivAlertCond  = enableDivAlerts and divBarConfirmed_a and bullDivPulse_a
bearDivAlertCond  = enableDivAlerts and divBarConfirmed_a and bearDivPulse_a

// --- Сами алерты
alertcondition(bullDivAlertCond, "Bullish Divergence (Alt-Market Regime)", "Bullish divergence: TOTAL3 makes LL while Ratio makes HL.")
alertcondition(bearDivAlertCond, "Bearish Divergence (Alt-Market Regime)", "Bearish divergence: TOTAL3 makes HH while Ratio makes LH.")
